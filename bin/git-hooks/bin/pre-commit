#!/usr/bin/env ruby
#
# Automatically link vendor scripts pre commit

require 'pathname'

REPO_DIR = "#{__dir__}/../.."

def files_from(dir)
  Pathname(dir).children.select(&:file?).map { |p| p.basename.to_s }
end

REPO_FILES = files_from(REPO_DIR)
VENDOR_FILES = files_from("#{REPO_DIR}/vendor")

def vendor_has_non_linked_files?
  (VENDOR_FILES & REPO_FILES) != VENDOR_FILES
end

def link_vendor_scripts
  `#{Pathname(REPO_DIR).join('link-vendor-scripts.sh')}`
end

def add_non_linked_vendor_scripts
  non_linked_vendor_scripts.each do |file|
    `git add #{REPO_DIR}/#{file}`
  end
end

def staged_files
  `git diff --name-only --cached`.split("\n").map { |f| File.basename(f) }
end

def non_linked_vendor_scripts
  non_linked_vendor_scripts = VENDOR_FILES - REPO_FILES
end

def staged_files_include_non_linked_scripts?
  staged_files.any? { |sf| non_linked_vendor_scripts.include?(sf) }
end

if vendor_has_non_linked_files? && staged_files_include_non_linked_scripts?
  link_vendor_scripts
  add_non_linked_vendor_scripts

  puts "Added non linked vendor scripts: #{non_linked_vendor_scripts}"
  puts
end
